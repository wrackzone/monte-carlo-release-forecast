<!DOCTYPE html>
<html>
<head>
    <title>prf</title>

    <script type="text/javascript" src="/apps/2.0/sdk.js"></script>
    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0/lib/analytics/analytics-all.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.3/moment.min.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("ForecastCalculator",function(){var self;return{extend:"Rally.data.lookback.calculator.TimeSeriesCalculator",config:{series:[]},constructor:function(config){return self=this,this.initConfig(config),this},getMetrics:function(){return[{field:"LeafStoryCount",as:"CountScope",f:"sum"},{field:"AcceptedLeafStoryCount",as:"CountAccepted",f:"sum"},{field:"LeafStoryPlanEstimateTotal",as:"PointsScope",f:"sum"},{field:"AcceptedLeafStoryPlanEstimateTotal",as:"PointsAccepted",f:"sum"}]},getDerivedFieldsOnInput:function(){return[]},getDerivedFieldsAfterSummary:function(){return[]}}}),Ext.define("CustomApp",{extend:"Rally.app.TimeboxScopedApp",componentCls:"app",scopeType:"release",samples:1e3,projectionSeries:"PointsAccepted",scopeSeries:"PointsScope",settingsScope:"project",config:{defaultSettings:{}},featureFetchFields:["_ValidFrom","_ValidTo","ObjectID","FormattedID","AcceptedLeafStoryCount","AcceptedLeafStoryPlanEstimateTotal","LeafStoryCount","LeafStoryPlanEstimateTotal"],_loadSnapshots:function(features,timeBox){var me=this,cPromises=_.map(features,function(feature,i){var deferred=Ext.create("Deft.Deferred");return me.getSnapshots(feature,timeBox).then({scope:me,success:function(snapshots){deferred.resolve(snapshots)}}),deferred});Deft.Promise.all(cPromises).then({scope:me,success:function(all){console.log("all",all),me._createForecast(all,timeBox)}})},_createForecast:function(featureSnapshots,timeBox){var me=this,lumenize=window.parent.Rally.data.lookback.Lumenize;console.log("lumenize",lumenize);var myCalc=Ext.create("ForecastCalculator",{series:[]}),config={deriveFieldsOnInput:myCalc.getDerivedFieldsOnInput(),metrics:myCalc.getMetrics(),summaryMetricsConfig:[],deriveFieldsAfterSummary:myCalc.getDerivedFieldsAfterSummary(),granularity:lumenize.Time.DAY,tz:"America/Chicago",holidays:[],workDays:"Monday,Tuesday,Wednesday,Thursday,Friday"};console.log("config",config),calculator=new lumenize.TimeSeriesCalculator(config),calculator.addSnapshots(_.flatten(featureSnapshots),timeBox.ReleaseStartDate,timeBox.ReleaseDate),console.log("calculator",calculator.getResults());var data=_.map(calculator.getResults().seriesData,function(series){return series[me.projectionSeries]}),categories=_.map(calculator.getResults().seriesData,function(series){return series.label});console.log("data",data);var index=_.findIndex(categories,function(cat){return cat===moment().format("YYYY-MM-DD")});console.log("index",index,categories[index]);var size=data.length-index;data=_.first(data,index+1);for(var scope=_.map(calculator.getResults().seriesData,function(series){return series[me.scopeSeries]}),projections=[],bounds=me._createVarianceBounds(data),i=0;me.samples>i;i++){var projection=me._createMonteCarloProjection(data,size,bounds);projections.push(projection)}me.addChart(me._createChartData(categories,data,scope,projections))},addChart:function(data){var that=this;_.isUndefined(that.chart)||that.remove(that.chart),that.chart=Ext.create("Rally.technicalservices.monteCarloChart",{itemId:"rally-chart",chartData:data}),that.add(that.chart)},_createChartData:function(categories,data,scope,projections){var me=this,chartData={categories:categories,series:[{name:me.projectionSeries,data:data},{name:me.scopeSeries,data:scope}]},samples=[];samples.push(_.min(projections,function(p){return _.last(p)})),samples.push(_.max(projections,function(p){return _.last(p)})),samples=samples.concat(_.first(projections,50)),chartData.series=chartData.series.concat(_.map(samples,function(p,i){return{name:"projection "+i,data:p,color:"#F5F5F5",marker:{enabled:!1},showInLegend:!1,zIndex:-1}}));var results=_.map(projections,function(p){return _.last(p)});console.log(_.map([.25,.5,.75],function(p){return results.percentile(p)}));var groups=_.groupBy(results,function(result){return 10*Math.round(result/10)});console.log("groups",groups);var values=_.map(_.keys(groups),function(key){return groups[key].length}),pValues=[.85],pcts=_.map(pValues,function(p){return results.percentile(p)}),lpcts=_.map([.1,.25,.5,.85,.99],function(p){return values.percentile(p)});return console.log("lpcts",lpcts),chartData.plotLines=_.map(pcts,function(p,i){return{color:"#C8C8C8 ",width:2,zIndex:4,label:{text:""+100*pValues[i]+"% = "+p},dashStyle:"dot",value:p}}),chartData},_createVarianceBounds:function(data){var diff=_.max(data)-_.min(data);console.log("diff",diff),diff=Math.floor(diff+1);var variances=_.compact(_.map(data,function(d,i){return data.length-1>i?data[i+1]-d:null}));console.log("variances",variances,variances.stdDev(),variances.median());var lower=0,upper=variances.median()+variances.stdDev();return console.log(lower,upper),{lower:lower,upper:upper}},_createMonteCarloProjection:function(data,size,bounds){var projection=_.map(data,function(d){return null}),start=_.last(data);for(x=0;size>x;x++)start+=Math.floor(Math.random()*bounds.upper+bounds.lower),projection.push(start);return projection},getSnapshots:function(feature,timeBox){var me=this,query=Ext.merge({ObjectID:feature.get("ObjectID"),$or:[{_ValidTo:"9999-01-01T00:00:00.000Z"},{_ValidTo:{$gte:timeBox.ReleaseStartDate}}]},{}),deferred=new Deft.Deferred;return Ext.create("Rally.data.lookback.SnapshotStore",{autoLoad:!0,limit:1/0,listeners:{refresh:function(store){for(var snapshots=[],i=0,ii=store.getTotalCount();ii>i;++i)snapshots.push(store.getAt(i).data);deferred.resolve(snapshots)}},fetch:me.featureFetchFields,find:query}),deferred.getPromise()},onScopeChange:function(scope){var me=this;console.log(scope.getRecord()),console.log(""+scope.getQueryFilter()),me._fetchData("PortfolioItem/Feature",["ObjectID"],scope.getQueryFilter()).then({scope:me,success:function(records){console.log("records",records),me._loadSnapshots(records,scope.getRecord().raw)},failure:function(error){console.log("error",error)}})},_fetchData:function(modelType,fetchFields,filters){var deferred=Ext.create("Deft.Deferred"),store=Ext.create("Rally.data.wsapi.Store",{model:modelType,limit:"Infinity",fetch:fetchFields,filters:filters,context:{workspace:this.getContext().getWorkspace()._ref,project:this.getContext().getProjectRef(),projectScopeDown:this.getContext().getProjectScopeDown(),projectScopeUp:!1}});return store.load({scope:this,callback:function(records,operation,success){success?deferred.resolve(records):deferred.reject(operation)}}),deferred}});
                (function(n){"use strict";var e=void 0,u=n.ps=n.ps||{},t=Array.prototype,r,i,f;t.sum=function(){for(var t=0,i=this,r=i.length,n=0;r>n;n++)t+=+i[n];return t},t.sample=function(n){var i=n,u=this,f=u.length,s="number"==typeof i&&f>i,e=[],r,o,t;if(s){for(o=Math.floor(i/10)+1,t=function(){return u[Math.floor(Math.random()*f)]},r=0;o>r;r++)e.push(t(),t(),t(),t(),t(),t(),t(),t(),t(),t());return e.slice(0,i)}return this},t.mean=function(){var n=this;return n.sum()/n.length},t.variance=function(){for(var t=this,i=t.length,u=t.mean(),r=0,n=0,n=0;i>n;n++)r+=Math.pow(t[n]-u,2);return r/i},t.stdDev=function(){return Math.sqrt(this.variance())},r=function(n){for(var r=this,o=r.length,s="max"===n?"max":"min",u=Math[s],t=0,i=1e5,f=[],h=Math.floor(o/i)+1,t=0;h>t;t++){var e=t*i,c=e+i,l=u.apply(Math,r.slice(e,c));f.push(l)}return u.apply(Math,f)},t.max=function(){return r.call(this,"max")},t.min=function(){return r.call(this,"min")},t.sortNumber=function(n){return n?this.sort(function(n,t){return n-t}).reverse():this.sort(function(n,t){return n-t})},t.median=function(){var i=this,r=i.length,u=1==r%2,n=Math.floor((r-1)/2),t=i.sortNumber();return u?t[n]:(t[n]+t[n+1])/2},t.percentile=function(n){var t=this,i=Math.floor(n*t.length);return t.sortNumber()[i]},t.histogram=function(){for(var r=this,u=r.length,n={},t=0,i,t=0;u>t;t++)i=r[t],"number"==typeof n[i]?n[i]++:n[i]=1;return n},t.countByType=function(){for(var r=this,u=r.length,n={},t=0,f=function(n){return{}.toString.call(n).match(/\s([a-z|A-Z]+)/)[1].toLowerCase()},i,t=0;u>t;t++)i=f(r[t]),n[i]!==e?n[i]++:n[i]=1;return n},i=u.math={},i.even=function(n){return"number"==typeof n&&0==n%2},i.odd=function(n){return"number"==typeof n&&1==n%2},i.fact=function(n){var t=1,i;if("number"!=typeof n||0!=n%1)t=null;else if(n>1)for(i=2;n>=i;i++)t*=i;return t},i.product=function(){for(var i=arguments,r=i.length,t=1,n=0;r>n;n++)t*=i[n];return t},i.randomBetween=function(n,t,i){var r="number"==typeof i&&i>0?i:0,u=+n,f=+(t-n),e=Math.random()*f+u;return e.toFixed(r)},i.randomNormal=function(n,t){var r,u,i;n=n||0,t=t||1;do r=2*Math.random()-1,u=2*Math.random()-1,i=r*r+u*u;while(i>=1||0===i);return n+t*r*Math.sqrt(-2*Math.log(i)/i)},f=u.stats={},f.normsinv=function(n){var f=[-39.69683028665376,220.9460984245205,-275.9285104469687,138.357751867269,-30.66479806614716,2.506628277459239],e=[-54.47609879822406,161.5858368580409,-155.6989798598866,66.80131188771972,-13.28068155288572],i=[-.007784894002430293,-.3223964580411365,-2.400758277161838,-2.549732539343734,4.374664141464968,2.938163982698783],u=[.007784695709041462,.3224671290700398,2.445134137142996,3.754408661907416],s=.02425,l=1-s,t,o,r,h=Math.sqrt,c=Math.log;return s>n?(t=h(-2*c(n)),o=(((((i[0]*t+i[1])*t+i[2])*t+i[3])*t+i[4])*t+i[5])/((((u[0]*t+u[1])*t+u[2])*t+u[3])*t+1)):n>l?(t=h(-2*c(1-n)),o=-(((((i[0]*t+i[1])*t+i[2])*t+i[3])*t+i[4])*t+i[5])/((((u[0]*t+u[1])*t+u[2])*t+u[3])*t+1)):(t=n-.5,r=t*t,o=(((((f[0]*r+f[1])*r+f[2])*r+f[3])*r+f[4])*r+f[5])*t/(((((e[0]*r+e[1])*r+e[2])*r+e[3])*r+e[4])*r+1)),+o}})(this);
                Ext.define("Rally.technicalservices.monteCarloChart",{extend:"Rally.ui.chart.Chart",alias:"widget.progresschart",itemId:"rally-chart",chartData:{},loadMask:!1,chartColors:[],chartConfig:{legend:{},chart:{type:"line",zoomType:"xy"},title:{text:"Release Forecast"},xAxis:{type:"linear",title:{enabled:!0,text:"Index"},startOnTick:!0,endOnTick:!0,tickInterval:7},yAxis:[{title:{text:"Points"}}],plotOptions:{series:{marker:{radius:2}},scatter:{tooltip:{}}}},constructor:function(config){_.first(this.chartConfig.yAxis).plotLines=config.chartData.plotLines,this.callParent(arguments),console.log("chart config",this.chartConfig),config.title&&(this.chartConfig.title=config.title)}});

            Rally.launchApp('CustomApp', {
                name:"prf",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
